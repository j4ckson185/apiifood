<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Central do Motoboy</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<!-- =====================  CSS  ===================== -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f5f5;--primary:#4285f4;--primary-dark:#2962d3;
  --success:#28a745;--warning:#f0ad4e;--danger:#c33;
  --shadow:0 2px 6px rgb(0 0 0 /.1);--radius:10px;--trans:.2s;
  font-family:system-ui,sans-serif
}
body{background:var(--bg);min-height:100vh;display:flex;flex-direction:column}
.hidden{display:none !important}

/*--- TOPBAR ------------------------------------------------------*/
#topbar{background:#fff;box-shadow:var(--shadow);padding:.75rem 1rem;
        display:flex;justify-content:space-between;align-items:center}
#topbar h1{font-size:1.1rem;font-weight:600;color:#444}
#logout-btn{background:none;border:none;color:var(--danger);
            font-size:.9rem;cursor:pointer}
#logout-btn i{margin-right:.3rem}

/*--- ABAS --------------------------------------------------------*/
#tabs{display:flex;border-bottom:1px solid #ddd;background:#fff}
.tab-btn{flex:1;text-align:center;padding:.7rem 0;cursor:pointer;
         font-weight:600;transition:var(--trans)}
.tab-btn.active{color:var(--primary);border-bottom:3px solid var(--primary)}
#panels{flex:1;overflow-y:auto;padding:1rem}
.panel{display:none}.panel.active{display:block}

/*--- CARDS DE PEDIDO --------------------------------------------*/
.order-card{width:100%;max-width:380px;margin:0 auto 1rem;
            background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
            overflow:hidden;display:flex;flex-direction:column}
.badge{align-self:flex-start;margin-left:.5rem;padding:.1rem .55rem;border-radius:999px;
       font-size:.75rem;font-weight:600;color:#fff}
.badge.NEW{background:var(--primary)}
.badge.DISPATCHED{background:var(--warning)}
.badge.CONCLUDED{background:var(--success)}
.order-header{display:flex;justify-content:space-between;align-items:center;
              padding:.9rem 1rem;cursor:pointer}
.order-header h3{font-size:1rem}
.order-header small{color:#555}
.order-body{padding:0 1rem 1rem;font-size:.9rem;color:#555;display:none}
.order-body.open{display:block}
.order-body div{margin-top:.45rem}
.order-actions{margin-top:.8rem;display:flex;gap:.5rem}
.order-actions button{flex:1;padding:.55rem;border:none;border-radius:6px;
                      font-weight:600;color:#fff;cursor:pointer;font-size:.82rem}
.dispatch{background:var(--warning)}
.finish{background:var(--success)}
.order-actions button:disabled{opacity:.6;cursor:not-allowed}

/*--- LOGIN -------------------------------------------------------*/
#login-box{max-width:320px;margin:auto;padding:2rem;background:#fff;
           border-radius:var(--radius);box-shadow:var(--shadow)}
#login-box h2{text-align:center;margin-bottom:1.4rem;color:#444}
#login-box input{width:100%;padding:.8rem;margin-bottom:1rem;border:1px solid #ccc;border-radius:6px}
#login-box button{width:100%;padding:.8rem;border:none;border-radius:6px;
                  background:var(--primary);color:#fff;font-weight:600;cursor:pointer;transition:var(--trans)}
#login-box button:hover{background:var(--primary-dark)}

/*--- TOAST -------------------------------------------------------*/
.toast{position:fixed;left:50%;bottom:1rem;transform:translateX(-50%);
       background:#333;color:#fff;padding:.6rem 1.2rem;border-radius:var(--radius);
       opacity:0;pointer-events:none;transition:opacity .3s}
.toast.show{opacity:1}

@media(max-width:480px){.order-header h3{font-size:.95rem}}
</style>
</head>
<body>

<!-- =====================  INTERFACE  ===================== -->
<header id="topbar" class="hidden">
  <h1>Central do Motoboy</h1>
  <button id="logout-btn"><i class="fas fa-sign-out-alt"></i>Sair</button>
</header>

<nav id="tabs" class="hidden">
  <div id="tab-active"   class="tab-btn active">Em andamento</div>
  <div id="tab-finished" class="tab-btn">Finalizados</div>
</nav>

<main id="panels" class="hidden">
  <section id="panel-active"   class="panel active"></section>
  <section id="panel-finished" class="panel"></section>
</main>

<!-- =====================  LOGIN  ===================== -->
<div id="login-box">
  <h2><i class="fas fa-user-shield"></i> Login Motoboy</h2>
  <input id="user" type="text" placeholder="Usuário" autocomplete="username">
  <input id="pass" type="password" placeholder="Senha" autocomplete="current-password">
  <button id="login-btn">Entrar</button>
</div>

<!-- =====================  TOAST  ===================== -->
<div id="toast" class="toast"></div>

<!-- =====================  JAVASCRIPT  ===================== -->
<script>
/* ================================================================
   1. ESTADO
=================================================================*/
const state = { active:{}, finished:{} };
const channel = new BroadcastChannel('dispatchChannel');

/* ================================================================
   2. HELPERS DE UI
=================================================================*/
const qs=s=>document.querySelector(s);
function toast(msg,type='info'){
  const t=qs('#toast');t.textContent=msg;
  t.style.background=type==='error'?'var(--danger)':'#333';
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2300);
}
function money(v){return 'R$ '+v.toFixed(2).replace('.',',');}
function badgeText(s){return s==='NEW'?'Novo':s==='DISPATCHED'?'Despachado':'Finalizado';}
function toggleTab(tab){
  const act=tab==='active';
  qs('#tab-active').classList.toggle('active',act);
  qs('#tab-finished').classList.toggle('active',!act);
  qs('#panel-active').classList.toggle('active',act);
  qs('#panel-finished').classList.toggle('active',!act);
}

/* ================================================================
   3. LOCAL STORAGE
=================================================================*/
function saveLocal(){
  localStorage.setItem('mbActive',JSON.stringify(state.active));
  localStorage.setItem('mbFinished',JSON.stringify(state.finished));
}
function loadLocal(){
  try{
    state.active  = JSON.parse(localStorage.getItem('mbActive'))   || {};
    state.finished= JSON.parse(localStorage.getItem('mbFinished')) || {};
  }catch{state.active={};state.finished={};}
}

/* ================================================================
   4. RENDERIZAÇÃO
=================================================================*/
function createCard(det){
  const c=document.createElement('div');c.className='order-card';c.dataset.id=det.id;
  c.innerHTML=`
    <div class="order-header">
      <div><h3>#${det.displayId}</h3><small>${det.customer}</small></div>
      <span class="badge ${det.status}">${badgeText(det.status)}</span>
    </div>
    <div class="order-body">
      <div><b>Endereço:</b> ${det.address}</div>
      <div><b>Valor:</b> ${money(det.total)}</div>
      <div><b>Pagamento:</b> ${det.payment}</div>
      <div class="order-actions"></div>
    </div>`;
  const body=c.querySelector('.order-body');
  c.querySelector('.order-header').onclick=()=>body.classList.toggle('open');
  return c;
}
function setStatus(card,status){
  const b=card.querySelector('.badge');
  b.className='badge '+status;
  b.textContent=badgeText(status);
}

function renderActive(det){
  const card=createCard(det);
  const acts=card.querySelector('.order-actions');
  acts.innerHTML = det.status==='NEW'
      ? `<button class="dispatch"><i class="fas fa-location-arrow"></i> Despachar</button>
         <button class="finish"><i class="fas fa-check"></i> Finalizar</button>`
      : `<button class="finish"><i class="fas fa-check"></i> Finalizar</button>`;

  acts.querySelectorAll('button').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      if(btn.classList.contains('dispatch')) handleDispatch(det.id,card,btn);
      else                                  handleFinish(det.id,card);
    };
  });
  qs('#panel-active').prepend(card);
}

function renderFinished(det){
  const card=createCard({...det,status:'CONCLUDED'});
  card.querySelector('.order-actions').remove();
  setStatus(card,'CONCLUDED');
  qs('#panel-finished').prepend(card);
}

function renderAll(){
  qs('#panel-active').innerHTML='';
  qs('#panel-finished').innerHTML='';
  Object.values(state.active).forEach(renderActive);
  Object.values(state.finished).forEach(renderFinished);
}

/* ================================================================
   5. BOTÕES
=================================================================*/
function handleDispatch(id,card,btn){
  btn.disabled=true;
  channel.postMessage({type:'dispatch-request',orderId:id});
  // muda UI de imediato; se admin negar, revertido no timeout
  state.active[id].status='DISPATCHED';
  setStatus(card,'DISPATCHED');
  btn.remove();
  saveLocal();

  // se admin não confirmar em 3 s volta ao estado anterior
  setTimeout(()=>{
    if(state.active[id] && state.active[id].status==='NEW'){
      renderAll();
      toast('Despacho não confirmado. Tente novamente.','error');
    }
  },3000);
}

function handleFinish(id,card){
  const det=state.active[id];det.status='CONCLUDED';
  state.finished[id]=det;delete state.active[id];
  card.remove();renderFinished(det);saveLocal();
  channel.postMessage({type:'status-update',orderId:id,status:'CONCLUDED'});
}

/* ================================================================
   6. CANAL (mensagens admin ↔ motoboy)
=================================================================*/
channel.addEventListener('message',e=>{
  const d=e.data;

  // admin enviou lista de pedidos atribuídos
  if(d?.type==='assign' && d.user===localStorage.getItem('motoboyUser')){
    d.orders.forEach(id=>{
      if(state.active[id]||state.finished[id]) return;
      // pede detalhes ao admin
      channel.postMessage({type:'details-request',orderId:id});
    });
  }

  // admin respondeu com detalhes completos
  if(d?.type==='details-response'){
    const det=d.data;
    if(!state.active[det.id] && !state.finished[det.id]){
      state.active[det.id]=det;renderActive(det);saveLocal();
    }
  }

  // confirmações de status vindas do admin
  if(d?.type==='status-update'){
    const {orderId,status}=d;
    if(status==='DISPATCHED' && state.active[orderId]){
      state.active[orderId].status='DISPATCHED';
      const card=qs(`.order-card[data-id="${orderId}"]`);
      if(card){setStatus(card,'DISPATCHED');card.querySelector('.dispatch')?.remove();}
      saveLocal();
    }
    if(status==='CONCLUDED' && state.active[orderId]){
      handleFinish(orderId,qs(`.order-card[data-id="${orderId}"]`));
    }
  }
});

/* ================================================================
   7. LOGIN
=================================================================*/
function enterUI(){
  qs('#login-box').classList.add('hidden');
  qs('#topbar').classList.remove('hidden');
  qs('#tabs').classList.remove('hidden');
  qs('#panels').classList.remove('hidden');
}

function doLogin(user){
  localStorage.setItem('motoboyUser',user);
  enterUI();loadLocal();renderAll();
  channel.postMessage({type:'motoboy-online',user});
}

qs('#login-btn').onclick=()=>{
  const u=qs('#user').value.trim().toLowerCase();
  const p=qs('#pass').value;
  if(u==='boaz'&&p==='boaz123') doLogin(u);
  else toast('Usuário ou senha inválidos','error');
};

qs('#logout-btn').onclick=()=>{localStorage.clear();location.reload()};

window.addEventListener('load',()=>{
  const u=localStorage.getItem('motoboyUser');
  if(u) doLogin(u);
});

/* ================================================================
   8. TABS
=================================================================*/
qs('#tab-active').onclick =()=>toggleTab('active');
qs('#tab-finished').onclick=()=>toggleTab('finished');
</script>
</body>
</html>
