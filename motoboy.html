<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Central do Motoboy</title>

<!-- Reaproveita seu CSS já existente -->
<link rel="stylesheet" href="styles.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

<style>
/* Pequenos ajustes visuais apenas para esta página */
body      { display: block; background:#f5f5f5; }
.login-box { max-width:320px;margin:8vh auto;padding:2rem;background:#fff;border-radius:8px;box-shadow:var(--shadow); }
.login-box h2{margin-bottom:1.5rem;text-align:center;color:var(--dark-gray);}
.login-box input{width:100%;padding:.8rem;margin-bottom:1rem;border:1px solid var(--medium-gray);border-radius:6px;}
.login-box button{width:100%;padding:.8rem;border:none;border-radius:6px;background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:var(--transition);}
.login-box button:hover{background:var(--primary-hover);}

.orders-panel{max-width:800px;margin:5vh auto;}
.orders-panel h2{margin-bottom:1rem;color:var(--dark-gray);}
.order-card-light{
    background:#fff;border-left:4px solid var(--primary-color);
    border-radius:6px;box-shadow:var(--shadow);padding:1rem;margin-bottom:1rem;
    display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;
}
.order-card-light .info{font-weight:600;font-size:1.1rem;}
.order-card-light .actions{display:flex;gap:.5rem;margin-top:.5rem;}
.order-card-light button{padding:.5rem 1rem;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:var(--transition);}
.order-card-light button.dispatch{background:#4285f4;color:#fff;}
.order-card-light button.finish{background:#28a745;color:#fff;}
.order-card-light button:hover{transform:translateY(-2px);opacity:.9;}
.hidden{display:none;}
</style>
</head>
<body>

<!-- BOX DE LOGIN -->
<div id="login-box" class="login-box">
    <h2><i class="fas fa-user-shield"></i> Login Motoboy</h2>
    <input id="user"  type="text" placeholder="Usuário" autocomplete="username" />
    <input id="pass"  type="password" placeholder="Senha"  autocomplete="current-password" />
    <button id="login-btn">Entrar</button>
</div>

<!-- LISTA DE PEDIDOS -->
<div id="orders-panel" class="orders-panel hidden">
    <h2><i class="fas fa-motorcycle"></i> Meus Pedidos</h2>
    <div id="motoboy-orders"></div>
</div>

<!-- Toasts -->
<div id="toast-container" class="toast-container"></div>

<script>
const CONFIG = {
  pollingInterval: 30000,      // já existia
  clientId:  'e6415912-782e-4bd9-b6ea-af48c81ae323',
  clientSecret: '137o75y57ug8fm55ubfoxlwjpl0xm25jxj18ne5mser23mbprj5nfncvfnr82utnzx73ij4h449o298370rjwpycppazsfyh2s0l'
};

// Canal de comunicação com a página-admin
const channel = new BroadcastChannel('dispatchChannel');

// --- Autenticação simples (Boaz / boaz123) -----------------
const loginBox   = document.getElementById('login-box');
const ordersBox  = document.getElementById('orders-panel');
const loginBtn   = document.getElementById('login-btn');

function showToast(msg,type='info'){
  const t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`${msg}`;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function auth(username,password){
  const okUser = username.toLowerCase()==='boaz';
  const okPass = password==='boaz123';
  return okUser && okPass;
}

loginBtn.onclick = async () => {
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value;
  if(auth(u,p)){
      loginBox.classList.add('hidden');
      ordersBox.classList.remove('hidden');
      localStorage.setItem('motoboyUser',u.toLowerCase());
      channel.postMessage({type:'motoboy-online',user:u.toLowerCase()});
      await ensureToken();                 // pega token da API
      requestExistingAssignments(u.toLowerCase()); // pede à admin o que já está atribuído
  }else{
      showToast('Usuário ou senha inválidos','error');
  }
};

async function fetchOwnToken(){
  const payload = {
    path:'/authentication/v1.0/oauth/token',
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`grantType=client_credentials&clientId=${CONFIG.clientId}&clientSecret=${CONFIG.clientSecret}`,
    isAuth:true
  };
  const r = await fetch('/.netlify/functions/ifood-proxy',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  if(!r.ok) throw new Error('Auth '+r.status);
  const data = await r.json();
  return data.accessToken;
}

// --- Obtém token via pagina admin --------------------------
// ❸ NOVA VERSÃO da ensureToken()
async function ensureToken () {
  if (state.accessToken) return;               // já temos

  // 1) tenta pegar o token da página-admin via BroadcastChannel
  const gotFromAdmin = await new Promise(resolve => {
    const listener = ev => {
      if (ev.data?.type === 'token') {
        state.accessToken = ev.data.token;
        channel.removeEventListener('message', listener);
        resolve(true);                         // conseguiu
      }
    };
    channel.addEventListener('message', listener);
    channel.postMessage({ type: 'token-request' });

    // timeout de 2 s — se ninguém respondeu, cai no fallback
    setTimeout(() => {
      channel.removeEventListener('message', listener);
      resolve(false);
    }, 2000);
  });

  if (gotFromAdmin) return;                    // sucesso

  // 2) fallback: gera um token só para o motoboy
  try {
    state.accessToken = await fetchOwnToken();
    console.log('[MOTOBOY] Token obtido diretamente');
  } catch (err) {
    console.error('[MOTOBOY] Falha ao obter token', err);
    showToast('Erro de autenticação (motoboy)', 'error');
  }
}

// --- Recebe atribuições ------------------------------------
channel.addEventListener('message', async (e)=>{
  const data=e.data;
  if(data?.type==='assign' && data.user===localStorage.getItem('motoboyUser')){
      for(const order of data.orders){
         await addOrderToList(order);      // busca detalhes na API e exibe
      }
  }
});

// Pede à página-admin para reenviar o que já está atribuído
function requestExistingAssignments(user){
  channel.postMessage({type:'ask-existing',user});
}

// --- Função para fazer requisições autorizadas via proxy ---
async function makeAuthorizedRequest(path,method='GET',body=null){
const attempt = async () =>{
    const headers={
      'Content-Type':'application/json',
      'Authorization':`Bearer ${state.accessToken}`
    };
    const payload={path,method,headers,body};
    const r=await fetch('/.netlify/functions/ifood-proxy',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    return r;
  };

  // garante token
  await ensureToken();

  let resp = await attempt();
  if(resp.status===401){
    // token expirou → renova localmente e tenta 1x
    state.accessToken = await fetchOwnToken();
    resp = await attempt();
  }
  if(!resp.ok) throw new Error('Erro '+resp.status);
  const txt = await resp.text();
  return txt ? JSON.parse(txt) : {};
}

// --- Renderiza pedido no painel ----------------------------
async function addOrderToList(orderId){
  // evita duplicação
  if(document.querySelector(`[data-order-id="${orderId}"]`)) return;

  let details;
  try{
     details = await makeAuthorizedRequest(`/order/v1.0/orders/${orderId}`,'GET');
  }catch(err){
     console.error('Erro ao buscar pedido',orderId,err);
     showToast(`Erro ao carregar pedido ${orderId}`,'error');
     return;
  }

  // card simples
  const card=document.createElement('div');
  card.className='order-card-light';
  card.dataset.orderId=orderId;
  card.innerHTML=`
     <div class="info">#${details.displayId || orderId.slice(0,8)}</div>
     <div class="actions">
       <button class="dispatch"><i class="fas fa-location-arrow"></i> Despachar</button>
       <button class="finish"><i class="fas fa-check"></i> Finalizar</button>
     </div>`;
  document.getElementById('motoboy-orders').appendChild(card);

  // Botões
  const dispatchBtn = card.querySelector('.dispatch');
  const finishBtn   = card.querySelector('.finish');

  dispatchBtn.onclick = () => updateStatus(orderId,'DISPATCHED',card,dispatchBtn);
  finishBtn.onclick   = () => updateStatus(orderId,'CONCLUDED',card,finishBtn);
}

async function updateStatus(orderId,status,card,btn){
  try{
    btn.disabled=true;
    await makeAuthorizedRequest(`/order/v1.0/orders/${orderId}/${status==='DISPATCHED'?'dispatch':'conclude'}`,'POST');
    showToast(`Pedido ${orderId.slice(0,6)} → ${status}`,'success');
    card.remove();                         // tira da lista
    // avisa admin
    channel.postMessage({type:'status-update',orderId,status});
  }catch(err){
    console.error(err);
    showToast('Erro ao atualizar status','error');
    btn.disabled=false;
  }
}
</script>
</body>
</html>
