<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Central do Motoboy</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f5f5;--primary:#4285f4;--primary-dark:#2962d3;
  --success:#28a745;--warning:#f0ad4e;--danger:#c33;
  --shadow:0 2px 6px rgb(0 0 0 /.1);--radius:10px;--trans:.2s;
  font-family:system-ui,sans-serif
}
body{background:var(--bg);min-height:100vh;display:flex;flex-direction:column}
.hidden{display:none !important}

/* TOPBAR -------------------------------------------------- */
#topbar{background:#fff;box-shadow:var(--shadow);padding:.75rem 1rem;
        display:flex;justify-content:space-between;align-items:center}
#topbar h1{font-size:1.1rem;font-weight:600;color:#444}
#logout-btn{background:none;border:none;color:var(--danger);
            font-size:.9rem;cursor:pointer}
#logout-btn i{margin-right:.3rem}

/* TABS ---------------------------------------------------- */
#tabs{display:flex;border-bottom:1px solid #ddd;background:#fff}
.tab-btn{flex:1;text-align:center;padding:.7rem 0;cursor:pointer;
         font-weight:600;background:#fff;transition:var(--trans)}
.tab-btn.active{color:var(--primary);border-bottom:3px solid var(--primary)}
#panels{flex:1;overflow-y:auto;padding:1rem}
.panel{display:none}.panel.active{display:block}

/* CARDS --------------------------------------------------- */
.order-card{
  width:100%;max-width:380px;margin:0 auto 1rem;               /* quadrado/coluna */
  background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
  overflow:hidden;display:flex;flex-direction:column
}
.badge{
  align-self:flex-start;margin-left:.5rem;padding:.1rem .55rem;border-radius:999px;
  font-size:.75rem;font-weight:600;color:#fff
}
.badge.NEW{background:var(--primary)}
.badge.DISPATCHED{background:var(--warning)}
.badge.CONCLUDED{background:var(--success)}

.order-header{display:flex;justify-content:space-between;align-items:center;
              padding:.9rem 1rem;cursor:pointer}
.order-header h3{font-size:1rem}
.order-header small{color:#555}

.order-body{padding:0 1rem 1rem 1rem;font-size:.9rem;color:#555;display:none}
.order-body.open{display:block}
.order-body div{margin-top:.4rem}

.order-actions{margin-top:.8rem;display:flex;gap:.5rem}
.order-actions button{flex:1;padding:.55rem;border:none;border-radius:6px;
                      font-weight:600;color:#fff;cursor:pointer;font-size:.82rem}
.dispatch{background:var(--warning)}.finish{background:var(--success)}
.order-actions button:disabled{opacity:.6;cursor:not-allowed}

/* LOGIN --------------------------------------------------- */
#login-box{max-width:320px;margin:auto;padding:2rem;background:#fff;
           border-radius:var(--radius);box-shadow:var(--shadow)}
#login-box h2{text-align:center;margin-bottom:1.4rem;color:#444}
#login-box input{width:100%;padding:.8rem;margin-bottom:1rem;
                 border:1px solid #ccc;border-radius:6px}
#login-box button{width:100%;padding:.8rem;border:none;border-radius:6px;
                  background:var(--primary);color:#fff;font-weight:600;cursor:pointer;transition:var(--trans)}
#login-box button:hover{background:var(--primary-dark)}

/* TOAST --------------------------------------------------- */
.toast{position:fixed;left:50%;bottom:1rem;transform:translateX(-50%);
       background:#333;color:#fff;padding:.6rem 1.2rem;border-radius:var(--radius);
       opacity:0;pointer-events:none;transition:opacity .3s}
.toast.show{opacity:1}
@media(max-width:480px){.order-header h3{font-size:.95rem}}
</style>
</head>
<body>

<header id="topbar" class="hidden">
  <h1>Central do Motoboy</h1>
  <button id="logout-btn"><i class="fas fa-sign-out-alt"></i>Sair</button>
</header>

<nav id="tabs" class="hidden">
  <div id="tab-active"   class="tab-btn active">Em andamento</div>
  <div id="tab-finished" class="tab-btn">Finalizados</div>
</nav>

<main id="panels" class="hidden">
  <section id="panel-active"   class="panel active"></section>
  <section id="panel-finished" class="panel"></section>
</main>

<div id="login-box">
  <h2><i class="fas fa-user-shield"></i> Login Motoboy</h2>
  <input id="user" type="text" placeholder="Usuário" autocomplete="username"/>
  <input id="pass" type="password" placeholder="Senha" autocomplete="current-password"/>
  <button id="login-btn">Entrar</button>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================================================================
   1. ESTADO & CONFIG
=================================================================*/
const state = {
  accessToken : null,
  active      : {},   // { orderId : details }
  finished    : {}
};
const CONFIG = {
  clientId     :'e6415912-782e-4bd9-b6ea-af48c81ae323',
  clientSecret :'137o75y57ug8fm55ubfoxlwjpl0xm25jxj18ne5mser23mbprj5nfncvfnr82utnzx73ij4h449o298370rjwpycppazsfyh2s0l'
};
const channel = new BroadcastChannel('dispatchChannel');

/* ================================================================
   2. HELPERS UI / TOAST / TABS
=================================================================*/
const qs = s=>document.querySelector(s);
function showToast(msg,type='info'){
  const t = qs('#toast'); t.textContent=msg;
  t.style.background = type==='error'? 'var(--danger)' : '#333';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2300);
}
function toggleTab(tab){
  qs('#tab-active').classList.toggle('active',tab==='active');
  qs('#tab-finished').classList.toggle('active',tab==='finished');
  qs('#panel-active').classList.toggle('active',tab==='active');
  qs('#panel-finished').classList.toggle('active',tab==='finished');
}

/* ================================================================
   3. TOKEN (mesmo do admin)
=================================================================*/
async function fetchOwnToken(){
  const payload={path:'/authentication/v1.0/oauth/token',method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`grantType=client_credentials&clientId=${CONFIG.clientId}&clientSecret=${CONFIG.clientSecret}`,
    isAuth:true};
  const r=await fetch('/.netlify/functions/ifood-proxy',
    {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok)throw new Error('auth'+r.status);return (await r.json()).accessToken;
}
async function ensureToken(){
  if(state.accessToken) return;
  const got=await new Promise(res=>{
    const listener=e=>{if(e.data?.type==='token'){state.accessToken=e.data.token;
        channel.removeEventListener('message',listener);res(true)}};
    channel.addEventListener('message',listener);
    channel.postMessage({type:'token-request'});
    setTimeout(()=>{channel.removeEventListener('message',listener);res(false)},1500);
  });
  if(got) return; state.accessToken=await fetchOwnToken();
}

/* ================================================================
   4. PERSISTÊNCIA LOCAL
=================================================================*/
function saveLocal(){
  localStorage.setItem('mbActive',JSON.stringify(state.active));
  localStorage.setItem('mbFinished',JSON.stringify(state.finished));
}
function loadLocal(){
  try{
    state.active   = JSON.parse(localStorage.getItem('mbActive'))   || {};
    state.finished = JSON.parse(localStorage.getItem('mbFinished')) || {};
  }catch{state.active={};state.finished={};}
}

/* ================================================================
   5. CARD RENDER
=================================================================*/
function fmtMoney(v){ return 'R$ '+v.toFixed(2).replace('.',','); }

function createCard(det){
  const card=document.createElement('div');card.className='order-card';card.dataset.id=det.id;
  card.innerHTML=`
    <div class="order-header">
      <div>
        <h3>#${det.displayId}</h3>
        <small>${det.customer}</small>
      </div>
      <span class="badge ${det.status}">${det.status==='NEW'?'Novo':det.status==='DISPATCHED'?'Despachado':'Finalizado'}</span>
    </div>
    <div class="order-body">
      <div><b>Endereço:</b> ${det.address}</div>
      <div><b>Valor:</b> ${fmtMoney(det.total)}</div>
      <div><b>Pagamento:</b> ${det.payment}</div>
      <div class="order-actions"></div>
    </div>`;
  const body = card.querySelector('.order-body');
  card.querySelector('.order-header').onclick = ()=>body.classList.toggle('open');
  return card;
}
function updateCardStatus(card,status){
  const b=card.querySelector('.badge');
  b.className='badge '+status;
  b.textContent = status==='DISPATCHED'?'Despachado':'Finalizado';
}

/* -------- Active -------- */
function renderActive(det){
  const card=createCard(det);
  const acts=card.querySelector('.order-actions');
  if(det.status==='NEW'){
    acts.innerHTML=`<button class="dispatch"><i class="fas fa-location-arrow"></i> Despachar</button>
                    <button class="finish"><i class="fas fa-check"></i> Finalizar</button>`;
  }else if(det.status==='DISPATCHED'){
    acts.innerHTML=`<button class="finish"><i class="fas fa-check"></i> Finalizar</button>`;
  }
  acts.querySelectorAll('button').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      if(btn.classList.contains('dispatch')) onDispatch(det.id,card);
      if(btn.classList.contains('finish'))   onFinishLocal(det.id,card);
    };
  });
  qs('#panel-active').prepend(card);
}
/* -------- Finished ------- */
function renderFinished(det){
  const card=createCard({...det,status:'CONCLUDED'});
  card.querySelector('.order-actions').remove();
  updateCardStatus(card,'CONCLUDED');
  qs('#panel-finished').prepend(card);
}
function renderAll(){
  qs('#panel-active').innerHTML='';
  qs('#panel-finished').innerHTML='';
  Object.values(state.active).forEach(renderActive);
  Object.values(state.finished).forEach(renderFinished);
}

/* ================================================================
   6. BOTÕES
=================================================================*/
function onDispatch(id,card){
  card.querySelector('.dispatch').disabled=true;
  // só envia pedido ao admin; ele fará a chamada na API
  channel.postMessage({type:'dispatch-request',orderId:id});
  state.active[id].status='DISPATCHED';
  updateCardStatus(card,'DISPATCHED');
  card.querySelector('.dispatch').remove();
  saveLocal();
}
function onFinishLocal(id,card){
  const det=state.active[id];det.status='CONCLUDED';
  state.finished[id]=det;delete state.active[id];
  card.remove();renderFinished(det);saveLocal();
  channel.postMessage({type:'conclude-request',orderId:id}); // admin decide chamar API
}

/* ================================================================
   7. RECEPÇÃO DE MENSAGENS (admin → motoboy)
=================================================================*/
channel.addEventListener('message',async e=>{
  const d=e.data;
  if(d?.type==='assign' && d.user===localStorage.getItem('motoboyUser')){
    for(const id of d.orders){
      if(state.active[id]||state.finished[id]) continue;
      try{
        await ensureToken();
        const info=await fetchOrderDetails(id);
        state.active[id]=info; renderActive(info); saveLocal();
      }catch(err){console.error(err);}
    }
  }
  if(d?.type==='status-update'){
    const {orderId,status}=d;
    if(state.active[orderId]){
      if(status==='DISPATCHED'){
        state.active[orderId].status='DISPATCHED';
        const c=qs(`.order-card[data-id="${orderId}"]`);
        if(c){updateCardStatus(c,'DISPATCHED');c.querySelector('.dispatch')?.remove();}
      }
      if(status==='CONCLUDED') onFinishLocal(orderId,qs(`.order-card[data-id="${orderId}"]`));
      saveLocal();
    }
  }
});

/* ================================================================
   8. DETALHES DO PEDIDO (mesmos campos do admin)
=================================================================*/
async function fetchOrderDetails(id){
  const o=await ensureToken().then(()=>fetch(`/order/v1.0/orders/${id}`,{
      headers:{Authorization:`Bearer ${state.accessToken}`}})).then(r=>r.json());
  // normaliza para o motoboy
  return {
    id,
    displayId : o.displayId || o.orderDisplayId || id.slice(0,8),
    customer  : o.customer?.name || `${o.customer?.firstName||''} ${o.customer?.lastName||''}`.trim() || '—',
    address   : o.deliveryAddress?.formattedAddress ||
                `${o.deliveryAddress?.streetName||''}, ${o.deliveryAddress?.number||''} - ${o.deliveryAddress?.neighborhood||''}`,
    total     : ((o.pricing?.totalPrice ?? o.totalPrice ?? 0)/100),
    payment   : o.payments?.[0]?.methodName || o.payments?.[0]?.method || '—',
    status    : 'NEW'
  };
}

/* ================================================================
   9. LOGIN / SESSÃO
=================================================================*/
const loginBox=qs('#login-box'),loginBtn=qs('#login-btn'),logoutBtn=qs('#logout-btn');
async function enterUI(){
  loginBox.classList.add('hidden');
  qs('#topbar').classList.remove('hidden');
  qs('#tabs').classList.remove('hidden');
  qs('#panels').classList.remove('hidden');
}
async function doLogin(user){
  localStorage.setItem('motoboyUser',user);
  await ensureToken();
  enterUI(); loadLocal(); renderAll();
  channel.postMessage({type:'motoboy-online',user});
}
loginBtn.onclick=async ()=>{
  const u=qs('#user').value.trim().toLowerCase();
  const p=qs('#pass').value;
  if(u==='boaz'&&p==='boaz123') await doLogin(u);
  else showToast('Usuário ou senha inválidos','error');
};
logoutBtn.onclick=()=>{localStorage.clear();location.reload()};

/* auto-login ----------------------------------------------------- */
window.addEventListener('load',()=>{
  const u=localStorage.getItem('motoboyUser');
  if(u){doLogin(u)}
});

/* ================================================================
   10. ABA
=================================================================*/
qs('#tab-active').onclick  =()=>toggleTab('active');
qs('#tab-finished').onclick=()=>toggleTab('finished');
</script>
</body>
</html>
