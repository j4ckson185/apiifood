<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Central do Motoboy</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f5f5f5;
      --primary:#4285f4;
      --primary-dark:#2962d3;
      --success:#28a745;
      --warning:#f0ad4e;
      --danger:#c33;
      --shadow:0 2px 6px rgba(0,0,0,.1);
      --radius:10px;
      font-family:system-ui,sans-serif
    }
    body{
      background:var(--bg);
      min-height:100vh;
      display:flex;
      flex-direction:column
    }
    .hidden{display:none !important}
    /* TOPBAR */
    #topbar{
      background:#fff;
      box-shadow:var(--shadow);
      padding:.75rem 1rem;
      display:flex;
      justify-content:space-between;
      align-items:center
    }
    #topbar h1{font-size:1.1rem;font-weight:600;color:#444}
    #logout-btn{
      background:none;
      border:none;
      color:var(--danger);
      font-size:.9rem;
      cursor:pointer
    }
    #logout-btn i{margin-right:.3rem}
    /* TABS */
    #tabs{
      display:flex;
      border-bottom:1px solid #ddd;
      background:#fff
    }
    .tab-btn{
      flex:1;
      text-align:center;
      padding:.7rem 0;
      cursor:pointer;
      font-weight:600
    }
    .tab-btn.active{
      color:var(--primary);
      border-bottom:3px solid var(--primary)
    }
    #panels{
      flex:1;
      overflow-y:auto;
      padding:1rem
    }
    .panel{display:none}
    .panel.active{display:block}
    /* CARDS */
    .order-card{
      width:100%;
      max-width:380px;
      margin:0 auto 1rem;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .badge{
      align-self:flex-start;
      margin-left:.5rem;
      padding:.1rem .6rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      color:#fff
    }
    .badge.NEW{background:var(--primary)}
    .badge.DISPATCHED{background:var(--warning)}
    .badge.CONCLUDED{background:var(--success)}
    .order-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:.9rem 1rem;
      cursor:pointer
    }
    .order-header h3{font-size:1rem}
    .order-header small{color:#555}
    .order-body{
      padding:0 1rem 1rem;
      font-size:.9rem;
      color:#555;
      display:none
    }
    .order-body.open{display:block}
    .order-body div{margin-top:.45rem}
    .order-actions{
      margin-top:.8rem;
      display:flex;
      gap:.5rem
    }
    .order-actions button{
      flex:1;
      padding:.55rem;
      border:none;
      border-radius:6px;
      font-weight:600;
      color:#fff;
      cursor:pointer;
      font-size:.82rem
    }
    .dispatch{background:var(--warning)}
    .finish{background:var(--success)}
    .order-actions button:disabled{
      opacity:.6;
      cursor:not-allowed
    }
    /* LOGIN */
    #login-box{
      max-width:320px;
      margin:auto;
      padding:2rem;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    #login-box h2{
      text-align:center;
      margin-bottom:1.4rem;
      color:#444
    }
    #login-box input{
      width:100%;
      padding:.8rem;
      margin-bottom:1rem;
      border:1px solid #ccc;
      border-radius:6px
    }
    #login-box button{
      width:100%;
      padding:.8rem;
      border:none;
      border-radius:6px;
      background:var(--primary);
      color:#fff;
      font-weight:600;
      cursor:pointer
    }
    #login-box button:hover{background:var(--primary-dark)}
    /* TOAST */
    .toast{
      position:fixed;
      left:50%;
      bottom:1rem;
      transform:translateX(-50%);
      background:#333;
      color:#fff;
      padding:.6rem 1.2rem;
      border-radius:var(--radius);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s
    }
    .toast.show{opacity:1}
    @media(max-width:480px){
      .order-header h3{font-size:.95rem}
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login-box">
    <h2><i class="fas fa-user-shield"></i> Login Motoboy</h2>
    <input id="user" type="text" placeholder="Usuário" autocomplete="username">
    <input id="pass" type="password" placeholder="Senha" autocomplete="current-password">
    <button id="login-btn">Entrar</button>
  </div>

  <!-- INTERFACE -->
  <header id="topbar" class="hidden">
    <h1>Central do Motoboy</h1>
    <button id="logout-btn"><i class="fas fa-sign-out-alt"></i>Sair</button>
  </header>

  <nav id="tabs" class="hidden">
    <div id="tab-active"   class="tab-btn active">Em andamento</div>
    <div id="tab-finished" class="tab-btn">Finalizados</div>
  </nav>

  <main id="panels" class="hidden">
    <section id="panel-active"   class="panel active"></section>
    <section id="panel-finished" class="panel"></section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- LÓGICA -->
  <script type="module">
    import { db, auth } from "./firebase-init.js";
    import {
      collection,
      doc,
      writeBatch,
      serverTimestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      onAuthStateChanged,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // CONFIGURAÇÃO PROXY iFood
    const CONFIG = {
      clientId:    'e6415912-782e-4bd9-b6ea-af48c81ae323',
      clientSecret:'137o75y57ug8fm55ubfoxlwjpl0xm25jxj18ne5mser23mbprj5nfncvfnr82utnzx73ij4h449o298370rjwpycppazsfyh2s0l'
    };

    // token global
    let _token = null;

    // obtém o token do iFood
async function fetchOwnToken() {
  // monta o form corretamente com clientId e clientSecret
  const params = new URLSearchParams();
  params.append('grantType',    'client_credentials');
  params.append('clientId',     CONFIG.clientId);
  params.append('clientSecret', CONFIG.clientSecret);
  const body = params.toString(); // "grantType=client_credentials&clientId=...&clientSecret=..."

  const headers = {
    'Content-Type': 'application/x-www-form-urlencoded'
  };

  const payload = {
    path:   '/authentication/v1.0/oauth/token',
    method: 'POST',
    headers,
    body,
    isAuth: true    // para o proxy não re-serializar o body
  };

  const res = await fetch('/.netlify/functions/ifood-proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  console.log('fetchOwnToken status=', res.status, 'body=', text);
  if (!res.ok) throw new Error(`auth ${res.status}: ${text}`);
  return JSON.parse(text).accessToken;
}

    // garante que só busque 1×
    async function ensureToken() {
      if (!_token) {
        _token = await fetchOwnToken();
      }
      return _token;
    }

    // wrapper genérico para API
    async function makeRequest(path, method='GET', body=null) {
      await ensureToken();
      const headers = {
        'Content-Type':'application/json',
        'Authorization':`Bearer ${_token}`
      };
      const r = await fetch('/.netlify/functions/ifood-proxy', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path, method, headers, body })
      });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const txt = await r.text();
      return txt ? JSON.parse(txt) : {};
    }

    // traduz método de pagamento
    function translatePayment(code,brand) {
      const map = { CASH:'Dinheiro', CARD:'Cartão', PIX:'PIX', PREPAID:'Pré-pago', ONLINE:'Online' };
      const key = code.toUpperCase();
      const lbl = map[key] || (key[0]+key.slice(1).toLowerCase());
      return brand ? `${lbl} (${brand})` : lbl;
    }

    // alert/toast
    function toast(msg,type='info'){
      const t = document.querySelector('#toast');
      t.textContent = msg;
      t.style.background = type==='error'? 'var(--danger)' : '#333';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),2300);
    }

    // badge e aba
    function badgeText(s){
      return s==='NEW'? 'Novo'
           : s==='DISPATCHED'? 'Despachado'
           : 'Finalizado';
    }
    function toggleTab(tab){
      const act = tab==='active';
      document.querySelector('#tab-active').classList.toggle('active',act);
      document.querySelector('#tab-finished').classList.toggle('active',!act);
      document.querySelector('#panel-active').classList.toggle('active',act);
      document.querySelector('#panel-finished').classList.toggle('active',!act);
    }

    // montadores de card
    function createCard(det){
      const c = document.createElement('div');
      c.className = 'order-card';
      c.dataset.id = det.id;
      c.innerHTML = `
        <div class="order-header">
          <div>
            <h3>#${det.displayId}</h3>
            <small>${det.customer}</small>
          </div>
          <span class="badge ${det.status}">
            ${badgeText(det.status)}
          </span>
        </div>
        <div class="order-body">
          <div><b>Endereço:</b> ${det.address}</div>
          <div><b>Valor:</b> R$ ${det.total.toFixed(2).replace('.',',')}</div>
          <div><b>Pagamento:</b> ${det.payment}</div>
          <div class="order-actions"></div>
        </div>`;
      c.querySelector('.order-header')
       .onclick = ()=>c.querySelector('.order-body').classList.toggle('open');
      return c;
    }
    function setStatus(card,s){
      const b = card.querySelector('.badge');
      b.className = 'badge '+s;
      b.textContent = badgeText(s);
    }
    function renderActive(det){
      const card = createCard(det);
      const acts = card.querySelector('.order-actions');
      acts.innerHTML = det.status==='NEW'
        ? `<button class="dispatch">
             <i class="fas fa-location-arrow"></i> Despachar
           </button>
           <button class="finish">
             <i class="fas fa-check"></i> Finalizar
           </button>`
        : `<button class="finish">
             <i class="fas fa-check"></i> Finalizar
           </button>`;
      acts.querySelectorAll('button').forEach(btn=>{
        btn.onclick = e=>{
          e.stopPropagation();
          if (btn.classList.contains('dispatch'))
            doDispatch(det.id,card,btn);
          else
            doFinish(det.id,card);
        };
      });
      document.querySelector('#panel-active').prepend(card);
    }
    function renderFinished(det){
      const card = createCard({...det,status:'CONCLUDED'});
      card.querySelector('.order-actions').remove();
      setStatus(card,'CONCLUDED');
      document.querySelector('#panel-finished').prepend(card);
    }
    function renderAll(){
      document.querySelector('#panel-active').innerHTML   = '';
      document.querySelector('#panel-finished').innerHTML = '';
      Object.values(state.active).forEach(renderActive);
      Object.values(state.finished).forEach(renderFinished);
    }

    // local storage
    function saveLocal(){
      localStorage.setItem('mbActive',  JSON.stringify(state.active));
      localStorage.setItem('mbFinished',JSON.stringify(state.finished));
    }
    function loadLocal(){
      try {
        state.active   = JSON.parse(localStorage.getItem('mbActive'))   || {};
        state.finished = JSON.parse(localStorage.getItem('mbFinished')) || {};
      } catch {
        state.active = {}; state.finished = {};
      }
    }

    // busca detalhes do pedido
    async function fetchOrderDetails(id){
      const o = await makeRequest(`/order/v1.0/orders/${id}`);
      const addr = o.delivery?.deliveryAddress || {};
      const address = addr.formattedAddress
        || `${addr.streetName||''},${addr.streetNumber||''}`
         + (addr.complement?` – ${addr.complement}`:'');
      const raw = o.pricing?.orderAmount
               || o.pricing?.totalPrice
               || o.pricing?.price?.value || 0;
      const customer = o.customer?.name
        || `${o.customer?.firstName||''} ${o.customer?.lastName||''}`.trim()
        || '—';
      const displayId = o.displayId || id.slice(0,8);
      const total = raw;
      const pm = o.payments?.methods?.[0] || {};
      const payment = translatePayment(pm.method||pm.methodType||'',pm.card?.brand);
      return { id, displayId, customer, address, total, payment, status:'NEW' };
    }

    // ações de dispatch e finish
    async function doDispatch(id,card,btn){
      const user = localStorage.getItem('motoboyUser');
      const ref = doc(db,'dispatchs',user,'orders',id);
      const batch = writeBatch(db);
      batch.set(ref,{ orderId:id, assignedAt:serverTimestamp() });
      await batch.commit();
      try {
        await makeRequest(`/order/v1.0/orders/${id}/dispatch`,'POST');
        toast('Pedido despachado no iFood','success');
      } catch(e){
        console.error(e);
        toast('Erro ao despachar no iFood','error');
      }
      state.active[id].status = 'DISPATCHED';
      setStatus(card,'DISPATCHED');
      btn.remove();
      saveLocal();
    }
    function doFinish(id,card){
      const det = state.active[id];
      det.status = 'CONCLUDED';
      state.finished[id] = det;
      delete state.active[id];
      card.remove();
      renderFinished(det);
      toast('Pedido finalizado','success');
      saveLocal();
    }

    // estado global
    const state = { active:{}, finished:{} };

    // inicia listener Firestore
    function startMotoboyListener(){
      const motoboyUser = localStorage.getItem('motoboyUser');
      if (!motoboyUser) return;
      const ordersCol = collection(db,'dispatchs',motoboyUser,'orders');
      onSnapshot(ordersCol,snap=>{
        snap.docChanges().forEach(async change=>{
          if (change.type==='added'){
            const orderId = change.doc.id;
            if (!state.active[orderId] && !state.finished[orderId]){
              const det = await fetchOrderDetails(orderId);
              state.active[orderId] = det;
              renderActive(det);
              saveLocal();
            }
          }
        });
      });
    }

    // Firebase Auth anônimo
    onAuthStateChanged(auth, async user => {
      if (!user) {
        try {
          await signInAnonymously(auth);
          console.log("Motoboy autenticado anonimamente");
        } catch(e) {
          console.error("Falha no anon-login:", e);
        }
      } else if (localStorage.getItem("motoboyUser")) {
        // já temos usuário no localStorage → inicia
        enterUI();
        loadLocal();
        renderAll();
        startMotoboyListener();
      }
    });

    // UI login/logout
    function enterUI(){
      document.querySelector('#login-box').classList.add('hidden');
      document.querySelector('#topbar').classList.remove('hidden');
      document.querySelector('#tabs').classList.remove('hidden');
      document.querySelector('#panels').classList.remove('hidden');
    }
    function doLogin(u){
      localStorage.setItem('motoboyUser',u);
      enterUI();
      loadLocal();
      renderAll();
      startMotoboyListener();
    }

    // eventos de botão
    document.querySelector('#login-btn').onclick = ()=>{
      const u = document.querySelector('#user').value.trim().toLowerCase();
      const p = document.querySelector('#pass').value;
      if (u==='boaz' && p==='boaz123') doLogin(u);
      else toast('Usuário ou senha inválidos','error');
    };
    document.querySelector('#logout-btn').onclick = ()=>{
      localStorage.clear();
      location.reload();
    };
    document.querySelector('#tab-active').onclick   = ()=>toggleTab('active');
    document.querySelector('#tab-finished').onclick = ()=>toggleTab('finished');

    // ao carregar a página, se já estiver logado
    window.addEventListener('load',()=>{
      const u = localStorage.getItem('motoboyUser');
      if (u) enterUI();
    });
  </script>

</body>
</html>
