<!DOCTYPE html>
<html>
<head>
    <title>Teste Events iFood</title>
    <style>
        .order-event {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .CFM { background-color: #e3f2fd; }
        .DDCR { background-color: #fff3e0; }
        .log { font-family: monospace; }
    </style>
</head>
<body>
    <h3>Token: <span id="token-status">Não autenticado</span></h3>
    <div id="orders"></div>
    <pre id="log" class="log"></pre>

    <script>
        const CONFIG = {
            merchantId: '2733980',
            merchantUUID: '3a9fc83b-ffc3-43e9-aeb6-36c9e827a143',
            clientId: 'e6415912-782e-4bd9-b6ea-af48c81ae323',
            clientSecret: '137o75y57ug8fm55ubfoxlwjpl0xm25jxj18ne5mser23mbprj5nfncvfnr82utnzx73ij4h449o298370rjwpycppazsfyh2s0l',
            pollingInterval: 30000
        };

        let accessToken = null;
        const logElement = document.getElementById('log');
        const tokenStatus = document.getElementById('token-status');

        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            logMessage += '\n';
            logElement.textContent += logMessage;
            console.log(message, data);
        }

        async function makeRequest(path, method = 'GET', body = null, isAuth = false) {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (!isAuth) {
                    if (!accessToken) {
                        log('Token não encontrado, tentando autenticar...');
                        await authenticate();
                    }
                    headers['Authorization'] = `Bearer ${accessToken}`;
                    if (path.includes('events')) {
                        headers['x-polling-merchants'] = CONFIG.merchantUUID;
                    }
                }

                const requestBody = {
                    path,
                    method,
                    headers,
                    isAuth
                };

                if (body) {
                    if (isAuth) {
                        requestBody.body = body;
                    } else {
                        requestBody.body = typeof body === 'string' ? body : JSON.stringify(body);
                    }
                }

                log(`Enviando requisição para ${path}`, requestBody);

                const response = await fetch('/.netlify/functions/ifood-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();
                log(`Resposta de ${path}:`, responseText);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                try {
                    return responseText ? JSON.parse(responseText) : null;
                } catch (e) {
                    log('Erro ao processar resposta:', e);
                    return null;
                }
            } catch (error) {
                log('Erro na requisição:', error);
                if (error.message.includes('401')) {
                    accessToken = null;
                    tokenStatus.textContent = 'Não autenticado';
                }
                throw error;
            }
        }

        async function authenticate() {
            log('Autenticando...');
            const formData = new URLSearchParams();
            formData.append('grantType', 'client_credentials');
            formData.append('clientId', CONFIG.clientId);
            formData.append('clientSecret', CONFIG.clientSecret);

            const data = await makeRequest(
                '/authentication/v1.0/oauth/token',
                'POST',
                formData.toString(),
                true
            );

            if (data && data.accessToken) {
                accessToken = data.accessToken;
                tokenStatus.textContent = 'Autenticado';
                log('Autenticado com sucesso. Token:', accessToken);
            } else {
                tokenStatus.textContent = 'Falha na autenticação';
                log('Falha na autenticação');
            }
        }

        async function processEvent(event) {
            log(`Processando evento: ${event.code}`, event);

            const orderElement = document.createElement('div');
            orderElement.className = `order-event ${event.code}`;
            orderElement.innerHTML = `
                <strong>Evento:</strong> ${event.code}<br>
                <strong>Pedido:</strong> ${event.orderId}<br>
                <strong>Data:</strong> ${new Date(event.createdAt).toLocaleString()}<br>
            `;
            document.getElementById('orders').prepend(orderElement);

            // Busca detalhes do pedido
            const orderDetails = await makeRequest(`/order/v1.0/orders/${event.orderId}`);
            log(`Detalhes do pedido:`, orderDetails);
        }

        async function pollEvents() {
            try {
                if (!accessToken) {
                    log('Sem token, autenticando...');
                    await authenticate();
                }

                log('Buscando eventos...');
                const events = await makeRequest('/events/v1.0/events:polling');
                
                if (events && Array.isArray(events) && events.length > 0) {
                    log(`${events.length} eventos recebidos`, events);

                    // Ordenar eventos por data
                    events.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                    // Processar eventos sequencialmente
                    for (const event of events) {
                        await processEvent(event);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }

                    // Acknowledgment
                    const ackPayload = events.map(e => ({id: e.id}));
                    log('Enviando acknowledgment:', ackPayload);
                    
                    const ackResult = await makeRequest(
                        '/events/v1.0/events/acknowledgment',
                        'POST',
                        ackPayload
                    );
                    log('Acknowledgment enviado', ackResult);
                } else {
                    log('Nenhum evento novo');
                }
            } catch (error) {
                log('Erro no polling:', error);
                if (error.message?.includes('401')) {
                    accessToken = null;
                    tokenStatus.textContent = 'Não autenticado';
                    await authenticate();
                }
            }
        }

        async function init() {
            await authenticate();
            await pollEvents();
            setInterval(pollEvents, CONFIG.pollingInterval);
        }

        init();
    </script>
</body>
</html>
